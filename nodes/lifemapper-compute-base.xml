<?xml version="1.0" standalone="no"?>

<kickstart>


	<description>
	Lifemapper-compute roll 
	Install on the frontend and compute nodes of the lmcompute cluster	
	</description>

	<copyright>
	Copyright (c) 2000 - 2012 The Regents of the University of California.
	All rights reserved. Rocks(r) v5.5/v6.0 www.rocksclusters.org
	
	</copyright>

	<changelog>
	$Log$
	</changelog>

	<!-- lifemapper dependencies -->
	<package>CharLS</package>
	<package>SuperLU</package>
	<package>armadillo</package>
	<package>arpack</package>
	<package>blas</package>
	<package>atlas</package>
	<package>cfitsio</package>
	<package>freexl</package>
	<package>gpsbabel</package>
	<package>lapack</package>
	<!-- Add devel, python -->
	<package>geos</package>
	<package>geos-devel</package>
	<package>geos-python</package>
	<!-- Add devel -->
	<package>hdf5</package>
	<package>hdf5-devel</package>
	<package>libaec</package>
 	<!-- Add libtiff for libgeotiff, brings --> 
	<package>glibc</package>     
	<package>jbigkit-libs</package>     
	<package>libgcc</package>     
	<package>libjpeg-turbo</package>     
	<package>libstdc++</package>
 	<!-- Note: brings i686 and x86_64 -->   
	<package>libtiff</package>  
	<package>libtiff-devel</package>  
	<package>nss-softokn-freebl</package>     
	<package>zlib</package>
	<package>libgeotiff</package>
	<package>libgeotiff-devel</package>
	<package>libdap</package>
	<package>libusb</package>
	<package>libgta</package>
	<package>ogdi</package>
	<package>netcdf</package>
	<package>openblas-openmp</package>     
	<package>postgresql-libs</package>
	<package>openjpeg2</package>
	<package>unixODBC</package>
	<package>xerces-c</package>
	<!-- Add devel, epsg, nad -->
	<package>proj49</package>
	<package>proj49-devel</package>
	<package>proj49-epsg</package>
	<package>proj49-nad</package>
	<package>shapelib-1.3.0-2.el7.x86_64.rpm
 	<package>gdal</package> 
 	<package>gdal-libs</package> 
 	<package>gdal-devel</package> 
 	<package>gdal-python</package> 
	<!-- Add gdal-python and resolved dependencies -->
	<package>python-nose</package>     
	<package>numpy</package>     
	<package>gdal-python</package>	
	<!-- Add geos, devel and python -->
	<package>geos</package>
	<package>geos-devel</package>
	<package>geos-python</package>

	<package>lifemapper-cctools</package>
	<package>lifemapper-openmodeller</package>
	<package>lifemapper-lmcompute</package>

	<!-- python prerequisites -->
	<package>opt-lifemapper-scipy</package>
	<package>opt-lifemapper-egenix-mx-base</package>
	<package>opt-lifemapper-pyparsing</package>
	<package>opt-lifemapper-requests</package>
	<package>opt-lifemapper-dendropy</package>

	<package>rocks-lmcompute</package>
<post>

/sbin/ldconfig

# Sync users on Frontend
HN=`eval hostname`
isFE=`rocks list host $HN | grep Frontend | wc -l`
if [ $isFE = 1 ]; then
    echo "Executing lifemapper-compute-base on FE" | tee -a $LOG
    /opt/rocks/bin/rocks sync users
else  
    echo "Executing lifemapper-compute-base on node" | tee -a $LOG
fi    

# Node directory NOT shared from frontend
/bin/mkdir -p /state/partition1/lmscratch/.java/.systemPrefs
/bin/mkdir -p /state/partition1/lmscratch/.java/.userPrefs
/bin/mkdir -p /state/partition1/lmscratch/job
/bin/mkdir -p /state/partition1/lmscratch/log
/bin/mkdir -p /state/partition1/lmscratch/temp
/bin/mkdir -p /state/partition1/lmscratch/test
/bin/mkdir -p /state/partition1/lmscratch/worker
/bin/chgrp -R lmwriter /state/partition1/lmscratch
/bin/chmod -R g+ws     /state/partition1/lmscratch

<file name="/etc/rc.d/rocksconfig.d/post-99-lifemapper-lmcompute" perms="0700">
#!/bin/bash
# do LM initialization

/sbin/ldconfig
/opt/lifemapper/rocks/bin/initLMcompute
rm -rf /etc/rc.d/rocksconfig.d/post-99-lifemapper-lmcompute

</file>

</post>

</kickstart>
 