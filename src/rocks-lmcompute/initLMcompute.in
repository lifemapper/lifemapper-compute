#!/bin/bash
#
# This script updates Lifemapper configuration file config/config.lmcompute.ini,
# installs cron jobs, and seeds default climate layers.
# Run by the roll install process on all nodes of lmcompute cluster

usage () 
{
    echo "Usage: $0"
    echo "This script is run during the roll install, it will:"
    echo "     - update config/config.lmcompute.ini file with values from "
    echo "       LMdbserver and LM_webserver attributes "
    echo "     - add [machine] section to config/config.lmcompute.ini  "
    echo "     - add maintenance scripts to /etc/cron.daily/ directory  "
    echo "   "
}

set_defaults() {
    BIN=@PKGROOT@/rocks/bin
    CONFIG_FILE=@LMHOME@/config/config.lmcompute.ini
    SITE_CONFIG_FILE=@LMHOME@/config/config.site.ini


    # get the SCENARIO_PACKAGE_SEED value from config.site.ini or config.lmserver.ini file
    echo "Looking for climate data $SCEN_PKG"   | tee -a $LOG  
    SCEN_PKG=`grep SCENARIO_PACKAGE_SEED $SITE_CONFIG_FILE | grep -v ';' | awk '{print $2}'`
    if [ ! "$SCEN_PKG" ] ; then 
        SCEN_PKG=`grep SCENARIO_PACKAGE_SEED $CONFIG_FILE | grep -v ';' | awk '{print $2}'`
    fi

    if [ ! "$SCEN_PKG" ] ; then
        echo "SCENARIO_PACKAGE_SEED not set in $SITE_CONFIG_FILE or $CONFIG_FILE" | tee -a $LOG
        exit 1
    fi

    LOG=@LMSCRATCHDISK@/log/`/bin/basename $0`.log
    rm -f $LOG
    touch $LOG
}

# update permissions on config files
updatePerms () {
    echo "-- set permissions on config files and layer database" >> $LOG
    GID=`grep lmwriter: /etc/group`
    if [ "$GID" != "" ] ; then
        chgrp  lmwriter @PKGROOT@/config/config*.ini*
        chmod g+ws @PKGROOT@/config/config*.ini*
        CLIMATE_DB=@DATADIR_SHARED@/@INPUT_LAYER_DIR@/@INPUT_LAYER_DB@    
        if [ -f $CLIMATE_DB ] ; then
            chgrp lmwriter $CLIMATE_DB
            chmod 644 $CLIMATE_DB
        fi 
    fi
}

# update linker paths
runLdconfig () {
    echo "-- run ldconfig" >> $LOG
    /sbin/ldconfig
}

# update config/config.lmcompute.ini
updateConfig () {
    echo "-- update IP in config file" >> $LOG
    $BIN/updateIP-lmcompute
}

# seed default Lifemapper environmental data
seedDefaultEnvData () {
    echo "-- seed environmental data" >> $LOG
    $BIN/seedData "$SCEN_PKG"
}


# install cron jobs for daily execution
installCronJobs () {
    echo "-- install cron jobs" >> $LOG
    $BIN/installComputeCronJobs
}

# source Lifemapper env
setEnv () {
    echo "-- set environment" >> $LOG
    PROF=/etc/profile.d/lmcompute.sh
    if [ -f $PROF ] ; then
	 . $PROF 
    else
    	echo "ERROR: file $PROF not found" 
    	exit
    fi
}

TimeStamp () {
    echo $1 `/bin/date` >> $LOG
}

#### Main #####
if [ $# -ne 0 ]; then
    usage
    exit 0
fi

TimeStamp "# Start"
set_defaults
setEnv
runLdconfig
updateConfig 
seedDefaultEnvData
installCronJobs
updatePerms
TimeStamp "# End"
