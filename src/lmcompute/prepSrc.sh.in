#!/bin/bash

# Purpose: checkout distro from lifemapper SVN and create *.tar.gz files to use in RPM. 
# NOTE: for svn checkout will be prompted for valid user/passwd.

SRC=@REPONAME@
URL=https://github.com/lifemapper/

# get distro from lifemapper git and needed updates
checkout_git () {
      echo "Starting GIT checkout from $URL"
      git clone $URL/$SRC

      if [ -d $SRC ]; then
          echo "Reset to version #@COMMIT_HASH@ in $SRC"
          cd $SRC
          git reset --hard @COMMIT_HASH@
          cd ..

          echo "Removing .svn in $SRC:"
          DIRS=`find $SRC -name .git`
          for i in $DIRS; do
              rm -rf $i
          done
      else
          echo "Error with GIT clone from $URL/$SRC: directory $SRC is not created"
      fi
}

collect_configs () {
  conf=$SRC/config/config.ini.in
  if [ ! -f $conf ]; then
      echo "ERROR: File $conf is missing from $SRC "
      return
  fi
}

# create distro files for lmcompute
create_distro () {
  if [ -d $SRC ]; then
      # create lmcompute src distro
      echo "Creating lmcompute src archive from svn checkout"
      tar czf lifemapper-lmcompute-@COMMIT_HASH@.tar.gz $SRC/* \
          --exclude=LmDebug \
          --exclude=LmDbServer \
          --exclude=LmServer \
          --exclude=LmWebServer      
  else
      echo "GIT clone directory $SRC is not present"
  fi
}

### main ###
checkout_git
collect_configs
create_distro
